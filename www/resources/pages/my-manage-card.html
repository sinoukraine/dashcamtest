<template>
	<div class="page my-manage-card" data-name="my-manage-card">
        <div class="navbar">
			<div class="navbar-inner">
				<div class="left">
					<a href="#" class="back link">
						<i class="f7-icons icon-left"></i>
					</a>
				</div>
				<div class="title">Manage the TF Card</div>
			</div>
		</div>
		<div class="page-content">
			<div class="list no-hairlines no-margin tablet-inset">
				<ul class="padding-left padding-right">
					<li>
						<div class="item-content no-padding">
							<div class="item-inner display-flex align-items-center justify-content-space-between row">
								<div class="item-title col-70">Total capacity</div>
								<div class="color-theme col-20 text-align-right">2340B</div>
								<a href="#" class="col-10"><i class="icon-f7 icon"></i></a>
							</div>
						</div>
					</li>
					<li>
						<div class="item-content no-padding">
							<div class="item-inner display-flex align-items-center justify-content-space-between row">
								<div class="item-title col-70">Free space</div>
								<div class="color-theme col-20 text-align-right">1240B</div>
								<a href="#" class="col-10"><i class="icon-f7 icon"></i></a>
							</div>
						</div>
					</li>
					<li>
						<div class="item-content no-padding">
							<div class="item-inner display-flex align-items-center justify-content-space-between row">
								<div class="item-title col-70">Cycling video space</div>
								<div class="color-theme col-20 text-align-right">0B</div>
								<a href="#" id="videoSpace" class="col-10"><i class="icon-f7 icon-basket color-theme"></i></a>
							</div>
						</div>
					</li>
					<li>
						<div class="item-content no-padding">
							<div class="item-inner display-flex align-items-center justify-content-space-between row">
								<div class="item-title col-70">Capture and waring video space</div>
								<div class="color-theme col-20 text-align-right">0B</div>
								<a href="#" id="clearVideo" class="col-10"><i class="icon-f7 icon-basket color-theme"></i></a>
							</div>
						</div>
					</li>
					<li>
						<div class="item-content no-padding">
							<div class="item-inner display-flex align-items-center justify-content-space-between row">
								<div class="item-title col-70">Capture and waring pictures space</div>
								<div class="color-theme col-20 text-align-right">0B</div>
								<a href="#" id="clearPictures" class="col-10"><i class="icon-f7 icon-basket color-theme"></i></a>
							</div>
						</div>
					</li>
					<li>
						<div class="item-content no-padding">
							<div class="item-inner display-flex align-items-center justify-content-space-between row">
								<div class="item-title col-70">Format</div>
								<a href="#" id="format" class="col-10"><i class="icon-f7 icon-basket color-theme"></i></a>
							</div>
						</div>
					</li>
				</ul>
			</div>
		</div>
	</div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				phoneMacAddress: '00.00.00.00.00.00',
			};            

            return ret;
        },
		methods: {			
			feedCommand: function(hex) {
				var self = this;					
				
				//7802F8334207
				if(self.phoneMacAddress != '00.00.00.00.00.00'){
					self.$app.preloader.show();
					
					let macAddress = self.phoneMacAddress.replace(/[^A-Za-z0-9]/g, "");
					//macAddress = macAddress.substr(1,macAddress.length -2);
					//App.dialog.alert(self.phoneMacAddress);
					self.socket.open(
					  "192.168.1.1",
					  10080,
					  function() {		
						//self.$app.preloader.hide();			
						//self.initConnectToCam();
						self.writeToCam("FFF0275D0100000010010006" + macAddress);
						//App.dialog.alert("FFF0275D0100000010010006" + macAddress);
					
						self.writeToCam(hex);										
					  },
					  function(errorMessage) {
						//self.$app.preloader.hide();
						App.dialog.alert('Cam is not initialized');	
						// invoked after unsuccessful opening of socket
					});
				}else{
					App.dialog.alert('Mac address is invalid');						
				}					
			},
			writeToCam: function(hex){
				var self = this;	
				let dataString = hex;
				let data = new Uint8Array(dataString.length/2);
				for (let i = 0, j = 0; i < data.length; i++, j+=2) {
					 data[ i ] = self.$app.methods.hexToDec(dataString[j] + dataString[j+1]);
				}
				
				self.socket.write(data);
			}
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;    			
				
				var myPage = $$('.my-manage-card');
				/*myPage.on('click', '.Sensitivity', function() {
					let state = $(this).val();
						if(state == 'low'){
							self.stateToggle('FFF00000010000007009000106', 'currentSensitivity', 'low');
						}else if(state == 'medium'){
							self.stateToggle('FFF0000001000000700900010F', 'currentSensitivity', 'medium');
						}else{
							self.stateToggle('FFF000000100000070090001FF', 'currentSensitivity', 'high');
						}
				});	*/
				
				window.MacAddress.getMacAddress(
					function(macAddress) {
						self.$setState({
							phoneMacAddress: macAddress,
						});
						self.feedCommand('FFF000000100000080070000');
					},function(fail) {
						App.dialog.alert('Phone Mac Address was not found');
					}
				);
				
				//self.$app.preloader.show();
				self.socket = new Socket();	
				
				self.socket.onData = function(data) {				
					let convertedData = data.reduce((acc, item) => {
					  let code = item.toString(16);
					  let formattedCode = ('0' + code).slice(-2);
					  return acc + formattedCode;
					}, '');
					App.dialog.alert(convertedData);
					
				  // invoked after new batch of data is received (typed array of bytes Uint8Array)
				};
				self.socket.onError = function(errorMessage) {
					self.$app.preloader.hide();
					App.dialog.alert('Can not change this state.');
				  // invoked after error occurs during connection
				};
				self.socket.onClose = function(hasError) {
					self.$app.preloader.hide();
					
					App.dialog.alert('Set successfully.');
				  // invoked after connection close
				};		
				
			}
		}
    };
</script>
    