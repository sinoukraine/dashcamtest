<template>
	<div class="page setting-page my-settings" data-name="my-settings">
        <div class="navbar">
            <div class="navbar-inner">
                <div class="left">
                    <a class="panel-open" href="#">
                        <i class="f7-icons icon-menu"></i>
                    </a>
                </div>
				<div class="title">Settings</div>
			</div>
		</div>
		<div class="page-content">
			<div class="list-block no-hairlines setting-list">
				<ul class="left-padding right-padding no-padding-top no-padding-bottom">
					<li class="item-content no-padding">
						<a href="#" class="my-mac-address item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Dashcam Name
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<li class="item-content no-padding">
						<a href="#" class="my-wifi-settings item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Wi-Fi Settings
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<!--<li class="item-content no-padding">
						<a href="/my-voice-prompt/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Voice Prompt
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>-->
					<li class="item-content">
						<div class="item-inner not-empty-state border-bottom">
							<a href="/my-resolution-settings/" class=" item-inner-bottom display-flex align-items-center justify-content-space-between">
								<span>Resolution</span>
								<i class="f7-icons icon-right"></i>
							</a>
							<!--<p class="item-bottom-text">Two options: Full HD 1080P/Full HD 720P</p>-->
						</div>
					</li>
					<li class="item-content">
						<div class="item-inner not-empty-state display-flex justify-content-space-between align-items-center border-bottom">
							<span class="item-caption">Sound Recording</span>
							<label class="toggle toggle-init">
								<input type="checkbox" name="SoundRecording" {{#if CheckedSoundOn}} checked {{/if}}>
								<span class="toggle-icon"></span>
							</label>
						</div>
					</li> 
					<li class="item-content no-padding">
						<div class="item-inner display-flex align-items-center justify-content-space-between">
							<span class="item-caption">Parking Voice Prompt</span>
							<label class="toggle toggle-init">
								<input type="checkbox" name="VoiceParking" {{#if CheckedVoiceParking}} checked {{/if}}>
								<span class="toggle-icon"></span>
							</label>
						</div>
					</li>					
					<li class="item-content">
						<div class="item-inner not-empty-state border-bottom">
							<div class="item-inner-bottom display-flex align-items-center justify-content-space-between">
								<span class="item-caption">Parked Vehicles Surveillance</span>
								<label class="toggle toggle-init">
									<input type="checkbox" name="Surveillance" {{#if CheckedSurveillance}} checked {{/if}}>
									<span class="toggle-icon"></span>
								</label>
							</div>
							<p class="item-bottom-text">After starting this, the device will judge vehicle status automatically: When the vehicle is in driving conditions, the device will record 30 frames per second's video loop; When the vehicle is in parking conditions, the device
								will record 1 frames per second.</p>
						</div>
					</li><!--
					<li class="item-content">
						<a href="#" class="my-sync item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Sync the mobile phone time to device
							</span>
						</a>
					</li>-->
					<li class="item-content">
						<div class="item-inner not-empty-state border-bottom">
							<a href="/my-conflict-sensitivity/" class="item-inner-bottom display-flex align-items-center justify-content-space-between">
								<span>
									Conflict Sensitivity
								</span>
								<i class="f7-icons icon-right"></i>
							</a>
							<p class="item-bottom-text">After starting this, if the vehicle has the conflict during the driving condition, the device will save real-time pictures automatically, meanwhile, the pictures will sync with mobile phone. When the device is out of storage, the
								device will replace early pictures. The sensitivity has low, medium, high standards.</p>
						</div>
					</li>
					<li class="item-content">
						<a href="/speed.unit.setting/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Speed Unit
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<li class="item-content">
						<div class="item-inner not-empty-state border-bottom">
							<a href="#" class="my-language-settings item-inner-bottom display-flex align-items-center justify-content-space-between">
								<span>
									Language
								</span>
								<i class="f7-icons icon-right"></i>
							</a>
							<!--<p class="item-bottom-text">Device has English/Russian language options, you can switch it according to your demand</p>-->
						</div>
					</li>					
					<li class="item-content">
						<a href="/version.setting/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between ">
							<span>
								Version Check 
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<!--
					<li class="item-content no-padding">
						<a href="/my-settings-service/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								After Sales Service
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<li class="item-content no-padding">
						<a href="/my-settings-note/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Note
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>-->
				</ul>
            </div>
        </div>
    </div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				//IsConnect: false,
				CamName: 'Dashcam',
				WiFiRouterIp: '0.0.0.0',
				Mac: '00.00.00.00.00.00',
				phoneMacAddress: '00.00.00.00.00.00',
				CheckedSoundOn: false,
				CheckedSurveillance: false,
				CheckedVoiceParking: false
			};            

            return ret;
        },
		methods: {			
			ssidHandler: function(a){		
				//setTimeout(function () { // Prepend new list element						
                    self.$setState({
                        CamName: a,
                    });					
				//}, 2000);
			},				
			fail: function(e){	
				//App.dialog.alert(e);
			},
			navigateMacAddress: function(){
				var self = this;
				var name = self.CamName;
				var mac = self.Mac;
				mainView.router.navigate('/my-mac-address/?name='+name.toString()+'&mac='+mac.toString());
			},
			navigateIp: function(){
				var self = this;
				var ip = self.WiFiRouterIp;
				mainView.router.navigate('/my-wifi-settings/?ip='+ip.toString());
			},
			navigateLanguage: function(){
				var self = this;
				var ip = self.WiFiRouterIp;
				mainView.router.navigate('/my-language-settings/');
			},
			navigateResolution: function(){
				var self = this;
				mainView.router.navigate('/my-resolution-settings/');
			},
			/*initConnectToCam: function(){
				var self = this;								
				
				self.$setState({
					IsConnect: true,
				});					
			},*/
			feedCommand: function(hex) {
				var self = this;					
				
				//7802F8334207
				if(self.phoneMacAddress != '00.00.00.00.00.00'){
					self.$app.preloader.show();
					
					let macAddress = self.phoneMacAddress.replace(/[^A-Za-z0-9]/g, "");
					//macAddress = macAddress.substr(1,macAddress.length -2);
					//App.dialog.alert(self.phoneMacAddress);
					self.socket.open(
					  "192.168.1.1",
					  10080,
					  function() {		
						//self.$app.preloader.hide();			
						//self.initConnectToCam();
						self.writeToCam("FFF0275D0100000010010006" + macAddress);
						//App.dialog.alert("FFF0275D0100000010010006" + macAddress);
					
						self.writeToCam(hex);										
					  },
					  function(errorMessage) {
						//self.$app.preloader.hide();
						App.dialog.alert('Cam is not initialized');	
						// invoked after unsuccessful opening of socket
					});
				}else{
					App.dialog.alert('Mac address is invalid');						
				}					
			},
			stateToggle: function(hex, name, data) {
				var self = this;					
				
				//7802F8334207
				if(self.phoneMacAddress != '00.00.00.00.00.00'){
					self.$app.preloader.show();
					
					let macAddress = self.phoneMacAddress.replace(/[^A-Za-z0-9]/g, "");
					//macAddress = macAddress.substr(1,macAddress.length -2);
					//App.dialog.alert(self.phoneMacAddress);
					self.socket.open(
					  "192.168.1.1",
					  10080,
					  function() {		
						//self.$app.preloader.hide();			
						//self.initConnectToCam();
						self.writeToCam("FFF0275D0100000010010006" + macAddress);
						//App.dialog.alert("FFF0275D0100000010010006" + macAddress);
					
						self.writeToCam(hex);						
						self.$app.methods.setInStorage({name: name, data: data});					
					  },
					  function(errorMessage) {
						//self.$app.preloader.hide();
						App.dialog.alert('Cam is not initialized');	
						// invoked after unsuccessful opening of socket
					});
				}else{
					App.dialog.alert('Mac address is invalid');						
				}					
			},
			writeToCam: function(hex){
				var self = this;	
				let dataString = hex;
				let data = new Uint8Array(dataString.length/2);
				for (let i = 0, j = 0; i < data.length; i++, j+=2) {
					 data[ i ] = self.$app.methods.hexToDec(dataString[j] + dataString[j+1]);
				}
				
				self.socket.write(data);
			}
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;    				
				var myPage = $$('.my-settings');
				
				window.MacAddress.getMacAddress(
					function(macAddress) {
						self.$setState({
							phoneMacAddress: macAddress,
						});
					},function(fail) {
						App.dialog.alert('Phone Mac Address was not found');
					}
				);
				
				//self.$app.preloader.show();
				self.socket = new Socket();	
				
				self.socket.onData = function(data) {

				
					let convertedData = data.reduce((acc, item) => {
					  let code = item.toString(16);
					  let formattedCode = ('0' + code).slice(-2);
					  return acc + formattedCode;
					}, '');
					App.dialog.alert(convertedData);
					
				  // invoked after new batch of data is received (typed array of bytes Uint8Array)
				};
				self.socket.onError = function(errorMessage) {
					self.$app.preloader.hide();
					App.dialog.alert('Can not change this state.');
				  // invoked after error occurs during connection
				};
				self.socket.onClose = function(hasError) {
					self.$app.preloader.hide();
					
					/*self.$setState({
						IsConnect: false,
					});	*/
					
					App.dialog.alert('Set successfully.');
				  // invoked after connection close
				};		
				
				//init start data
								
				var currentSoundOn = self.$app.methods.getFromStorage("settingSoundOn");
				
				if(currentSoundOn == 'on'){
					self.$setState({
                        CheckedSoundOn: true,
                    });
				}else{
					self.$setState({
                        CheckedSoundOn: false,
                    });
				}	
				
				var currentSurveillance = self.$app.methods.getFromStorage("settingSurveillance");
				
				if(currentSurveillance == 'on'){
					self.$setState({
                        CheckedSurveillance: true,
                    });
				}else{
					self.$setState({
                        CheckedSurveillance: false,
                    });
				}
				
				var currentVoiceParking = self.$app.methods.getFromStorage("settingVoiceParking");
				
				if(currentVoiceParking == 'on'){
					self.$setState({
                        CheckedVoiceParking: true,
                    });
				}else{
					self.$setState({
                        CheckedVoiceParking: false,
                    });
				}
				
				//WifiWizard.getCurrentSSID(self.ssidHandler, self.fail);
				WifiWizard2.getConnectedSSID().then(response => {	
					//App.dialog.alert(JSON.stringify(response));	

					let mySSID = JSON.stringify(response);
					var pattern = /AUTO-VOX/i;
					var pattern1 = /M-/i;
					
					if ((pattern.test(mySSID) || pattern1.test(mySSID))) {	
						self.$setState({
							CamName: mySSID.substr(1,mySSID.length -2),
						});			
					}else{
						self.$app.preloader.show();
						setTimeout(function () { // Prepend new list element	
							self.$app.preloader.hide();							
							self.$app.dialog.alert('No Dashcam connected');
							self.$app.methods.openCam();					
						 }, 2000);
						//
						
							
										
					}					
				});	
				
				WifiWizard2.getConnectedBSSID().then(response => {	
					//App.dialog.alert(JSON.stringify(response));
					self.$setState({
                        Mac: JSON.stringify(response),
                    });						
				});	
								
				WifiWizard2.getWifiRouterIP().then(response => {						
					self.$setState({
                        WiFiRouterIp: JSON.stringify(response),
                    });						
				});	
				
				myPage.on('click', '.my-mac-address', self.navigateMacAddress);
				myPage.on('click', '.my-wifi-settings', self.navigateIp);
				myPage.on('click', '.my-language-settings', self.navigateLanguage);
				myPage.on('click', '.my-resolution', self.navigateResolution);

				myPage.on('click', '[name="SoundRecording"]', function() {
					//if(!self.IsConnect){
						if($(this).is(":checked")){
							self.stateToggle('FFF00000010000007007000101', 'settingSoundOn', 'on');
						}else{
							self.stateToggle('FFF00000010000007007000100', 'settingSoundOn', 'off');
						}
					/*}else{
						App.dialog.alert('Please wait while state is changing.');
					}*/
				});	

				myPage.on('click', '[name="Surveillance"]', function() {
					//if(!self.IsConnect){
						if($(this).is(":checked")){
							self.stateToggle('FFF00000010000007011000101', 'settingSurveillance', 'on');
						}else{
							self.stateToggle('FFF00000010000007011000100', 'settingSurveillance', 'off');
						}
					/*}else{
						App.dialog.alert('Please wait while state is changing.');
					}*/
				});

				myPage.on('click', '[name="VoiceParking"]', function() {
					//if(!self.IsConnect){
						if($(this).is(":checked")){
							self.stateToggle('FFF00000010000007111000101', 'settingVoiceParking', 'on');
						}else{
							self.stateToggle('FFF00000010000007111000100', 'settingVoiceParking', 'off');
						}
					/*}else{
						App.dialog.alert('Please wait while state is changing.');
					}*/
				});

				
				myPage.on('click', '.my-sync', function() {
					self.feedCommand('FFF00000010000003002');						
				});
				
			}
		}
    };
</script>
    