<template>
	<div data-name="my-list" class="page open-dashcam-page my-list">
		<div class="navbar">
			<div class="navbar-inner">
				<div class="left">
					<a class="panel-open" href="#">
						<i class="f7-icons icon-menu"></i>
					</a>
				</div>
				<div class="title">Home</div>
			</div>
		</div>

		<div class="toolbar toolbar-bottom" id="openCam">
			<div class="toolbar-inner">
				<a class="btn-cs" href="#">
					open dashcam
				</a>
			</div>
		</div>

		<div class="page-content">
			<div class="block">
				{{#if ShowCamList}}
				<p class="item-title open-title">
					Check the box of the desired dashcam and click the OPEN DASHCAM button.
				</p>
				{{else}}
				<div key="VirtualListPreloader" class="block text-align-center">
                    <div class="preloader color-blue"></div>
                </div>
				{{/if}}
			</div>
			<div class="list virtual-list open-cam-list no-hairlines">
				
			</div>
		</div>
	</div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				ShowCamList: false
			};            

            return ret;
        },
		methods: {
			listHandler: function(a){	
				var self = this; 	
				App.dialog.alert(a.length);			
				//var camArr = names.split(',');

				var items = [];
				let index = 1;
				for (var i = 1; i <= a.length; i++) {
					var pattern = /AUTO-VOX/i;
					
					if (pattern.test(a[i])) {						
						self.$setState({
							ShowCamList: true,
						});	
						
						items.push({
							title: a[i].substr(1,a[i].length -2),
							value: index,
						});	

						index++;						
					}
				}

				var deletecamList = App.virtualList.create({
					// List Element
					el: '.open-cam-list',
					// Pass array with items
					items: items,
					// Custom search function for searchbar
					searchAll: function(query, items) {
						var found = [];
						for (var i = 0; i < items.length; i++) {
							if (items[i].title.toLowerCase().indexOf(query.toLowerCase()) >= 0 || query.trim() === '') found.push(i);
						}
						return found; //return array with mathced indexes
					},
					// List item Template7 template
					itemTemplate: '<li>' +
						'<label class="item-radio item-content">' +
						'<input type="radio" name="demo-radio" class="radio-cam" value="{{title}}" />' +
						'<div class="item-media">' +
						'<div class="item-media-inner">' +
						'<p>DC</p>' +
						'</div>' +
						'</div>' +
						'<div class="item-inner">' +
						'<div class="item-title">{{title}}</div>' +
						'</div>' +
						'<i class="icon icon-radio"></i>' +
						'</label>' +
						'</li>',
					// Item height
					height: app.theme === 'ios' ? 73 : (app.theme === 'md' ? 73 : 73),
				});
			},	
			fail: function(e){
				var self = this; 
				self.$setState({
                    ShowCamList: false,
                });						
			},			
			connectWiFi: function(SSID){
				let permissions = cordova.plugins.permissions;
				
				if (!permissions) {
					App.dialog.alert('plugin not supported')
				} else {
					permissions.hasPermission(permissions.CHANGE_WIFI_STATE, function(status) {//READ_EXTERNAL_STORAGE WRITE_EXTERNAL_STORAGE
						if (status.hasPermission) {
							WifiWizard.connectNetwork(SSID, self.winConnect, self.failConnect);
							//App.dialog.alert('WIFI permission is turned on');
							/*var fp = 'file:///data/user/0/com.sinopacific.dashcamtest/files/'; 
							fp = fp + "/dashcam_videos/video_001.MP4";
							VideoPlayer.play(fp);
							*/
							
							//DownloadFile("http://192.168.1.1/DCIM/101video/20190530120221_10.MP4", "dashcam_002", "video_002");
							////DownloadFile("https://ic.pics.livejournal.com/i_m_ho/25019411/3647584/3647584_600.png", "dashcam_001", "alarm_001");
							//App.dialog.alert('video downloaded 0');
							/*navigator.screenshot.save(function(error,res){
							  if(error){
								console.error(error);
							  }else{
								console.log('ok',res.filePath);
							  }
							});*/
						} else {
							permissions.requestPermission(permissions.CHANGE_WIFI_STATE, success, error);
							
							function error() {
								App.dialog.alert('no change WiFi permission');
							}

							function success(status1) {
								//App.dialog.alert('WIFI permission is turned on');
								WifiWizard.connectNetwork(SSID, self.winConnect, self.failConnect);
								
								//DownloadFile("http://192.168.1.1/DCIM/101video/20190530120221_10.MP4", "dashcam_002", "video_002");
								//App.dialog.alert('video downloaded 1');
								//DownloadFile("http://192.168.1.1/DCIM/100video/20190606190422_180.MP4", "dashcam_videos", "video_001");
								//App.dialog.alert('video downloaded 1');//DownloadFile("https://ic.pics.livejournal.com/i_m_ho/25019411/3647584/3647584_600.png", "dashcam_001", "alarm_001");
								/*navigator.screenshot.save(function(error,res){
								  if(error){
									console.error(error);
								  }else{
									console.log('ok',res.filePath);
								  }
								});*/
								if (!status1.hasPermission) error();
							}
						}
					});
				}
			},			
			winConnect: function () {
				//validWiFi = true;
				App.dialog.alert("Connected to camera");
				//loadCarcamPage();
			}

			failConnect: function (e) {
				App.dialog.alert("Failed connect "+e);
			}
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;    
				
				WifiWizard.listNetworks(self.listHandler, self.fail);

				var myPage = $$('.my-list');
				
				myPage.on('click', '#openCam', function(e){		
					var selectedCam = $$('[name="demo-radio"]');
					selectedCam.forEach(function() {
						if($(this).is(":checked")){
							App.dialog.alert($(this).val());
							self.connectWiFi($(this).val());						
						}					
				});
				
            }
		}
    };
</script>
    