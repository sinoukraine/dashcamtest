<template>
	<div data-name="my-gallery" class="page gallery">
		<div class="navbar">
			<div class="navbar-inner">
				<div class="left">
					<a class="panel-open" href="#">
						<i class="f7-icons icon-menu"></i>
					</a>
				</div>
				<div class="title">Gallery</div>
				<div class="right">
					<a href="#" >
						<i class="f7-icons icon-sort"></i>
					</a>
					<a href="#" >
						<i class="f7-icons icon-done"></i>
					</a>
				</div>
				<div class="subnavbar">
					<div class="toolbar tabbar" id="toolbar-menu">
						<div class="toolbar-inner">
							<a href="#photo" class="tab-link tab-link-active" >
								<span class="tabbar-label"><b>Photo</b></span>
							</a>
							<a href="#video" class="tab-link">
								<span class="tabbar-label"><b>Video</b></span>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="tabs ptr-content">
			<!-- First tab, active -->
			<div class="page-content tab tab-active" id="photo">
				<div class="block">
					<div class="ptr-preloader">
						<div class="preloader"></div>
						<div class="ptr-arrow"></div>
					</div>
					<div class="list virtual-list photo-list no-hairlines">
					{{#if ShowPhotoList}}
						<div key="VirtualPhotoList" class="list media-list virtual-list no-hairlines no-margin no-chevron searchbar-found photosList">
						</div> 
					{{/if}}
					</div>
				</div>
			</div>
			<!-- First tab, active -->
			<div class="page-content tab" id="video">
				<div class="block">
					<div class="ptr-preloader">
						<div class="preloader"></div>
						<div class="ptr-arrow"></div>
					</div>
					<div class="list virtual-list video-list no-hairlines">
					{{#if ShowVideoList}}
						<div key="VirtualVideoList" class="list media-list virtual-list no-hairlines no-margin no-chevron searchbar-found videosList">
						</div> 
					{{/if}}
					</div>					
				</div>
			</div>
		</div>
	</div>
</template>

<script>
  // script must return component object
    return {
        data: function () {
            var self = this;
			var ret = {
				photoBrowserArr: [],
                VirtualPhotoList: false,
                VirtualVideoList: false,
				ShowPhotoList: false,	
				ShowVideoList: false,			
            }; 			
            return ret;
        },
        methods: {
            getGalleryList: function(){
				/*let getPhotoJson = { 
					"type": "alarmvideo", 
					"mp4folder": "DCIM/101video", 
					"titlefolder": "DCIM/105thumb", 
					"imagefolder": "DCIM/104snap", 
					"mp4data": [] 
				};*/
					
				var self = this;   
				
                self.$app.preloader.show();
				self.$app.methods.getRecordPhoto().then(response => {			
					//self.methods.setPhotoList({list: response.mp4data});	
					self.$app.methods.setInStorage({name: 'photoList', data: response.mp4data});
                    self.$setState({
                        ShowPhotoList: true,
                    });
                    self.$app.utils.nextFrame(()=>{
                        self.initPhotoList(response.mp4data);
                    });					
					self.$app.preloader.hide(); 	
				}, error => {
					self.$app.preloader.hide(); 
					console.log('Error occured at Get Alarm Photo List');
                    self.$app.dialog.alert('Error occured at Get Alarm Photo List');
				});
				
				self.$app.preloader.show();
				self.$app.methods.getRecordVideo().then(response => {			
					//self.methods.setPhotoList({list: response.mp4data});	
					self.$app.methods.setInStorage({name: 'videoList', data: response.mp4data});
                    self.$setState({
                        ShowVideoList: true,
                    });
                    self.$app.utils.nextFrame(()=>{
                        self.initVideoList(response.mp4data);
                    });					
					self.$app.preloader.hide(); 	
				}, error => {
					self.$app.preloader.hide(); 
					console.log('Error occured at Get Video List');
                    self.$app.dialog.alert('Error occured at Get Video List');
				});
            },
            initPhotoList: function(photoListArr = []){
                var self = this;
                
                var listEl = self.$el.find('.photosList'); 
                //var listSearchEl = self.$el.find('.searchbar');    
                var photoList = self.$app.methods.getFromStorage("photoList");
				let dateArr = self.$app.methods.sortDatePhoto(photoList);           
                console.log(dateArr);
                /*if (photoListArr.length) {
                    photoListArr.sort(function(a,b){
                        if(a.AccountName < b.AccountName) return -1;
                        if(a.AccountName > b.AccountName) return 1;
                        return 0;
                    });
                }*/
				
				self.photoBrowserArr.length = 0;
				
                self.VirtualPhotoList = App.virtualList.create({
                    el: listEl, 
                    setListHeight: false,
                    // search item by item
                    searchAll: function (query, items) {
                        /*var found = [];
                        query = query.trim().toLowerCase();   
                        for (var i = 0; i < items.length; i++) {
                            if (items[i].AccountName.toLowerCase().indexOf(query) >= 0 || 
                                items[i].EMail.toLowerCase().indexOf(query) >= 0 ||                                
                                query === '') found.push(i);
                        }
                        return found; //return array with mathced indexes*/
						let found = [];
						for (let i = 0; i < items.length; i++) {
							if (items[i].title.toLowerCase().indexOf(query.toLowerCase()) >= 0 || query.trim() === '') found.push(i);
						}
						return found;
                    },
					
                    //List of array items
                    items: dateArr,
                    height: function(item){
                        let height = 134.94;
                        return height;
                    },
                    // Display the each item using Template7 template parameter
                    renderItem: function (item, index) {                  
                        var ret = '';
						
						ret += '<div class="list media-list">';
						ret += '  <ul>';
						ret += '	<li>';
						ret += '	  <div class="item-content">      ';  
						ret += '		<div class="item-inner">';
						ret += '		  <div class="item-title-row">';
						ret += '			<div class="item-title">' + item.title + '</div>  ';          
						ret += '		  </div>          ';
						ret += '		  <div class="item-text">';
						ret += '			<div class="row">';
						
						for (let d = 0; d < item.data.length; d ++){	
							let time = item.data[d].time.substring(8, 10) + ':' + item.data[d].time.substring(12, 14);
							for (let a = 0; a < item.data[d].associateddata.length; a ++){
								
								self.photoBrowserArr.push('http://192.168.1.1/DCIM/104snap/'+item.data[d].associateddata[a].image);
								///my-photo/?code=http://192.168.1.1/DCIM/104snap/'+item.data[d].associateddata[a].image+'
								ret += '			  <div class="col-50">';
								ret += 					'<a href="#" class="pb-standalone-dark" data-photo="'+item.data[d].associateddata[a].image+'">' +
														'<div class="item-content">' +
														'<div class="item-media photo-item-media"><label class="checkbox check-item"><input type="checkbox" name="checkbox-photo"><i class="icon-checkbox"></i></label>' +
														'<img class="photo-path" data-path="http://192.168.1.1/DCIM/104snap/'+item.data[d].associateddata[a].image+'" src="http://192.168.1.1/DCIM/104snap/'+item.data[d].associateddata[a].image+'">' +
														
														'</div>' +
														'</div>' +
														'</a>';
								ret += '			  </div> ';			
							}						
						}
						
						ret += '			</div>';
						ret += '		  </div>';
						ret += '		</div>';
						ret += '	  </div>';
						ret += '	</li>';
						ret += '  </ul>';
						ret += '</div>';
												
						return ret;
                    }
                });				
				
				console.log('ar',self.photoBrowserArr);
				self.PhotoBrowserObj = self.$app.photoBrowser.create({
					theme : 'dark',
					toolbar : false,
					renderNavbar : function() {
						return '<div class="navbar"><div class="navbar-inner"><div class="left"><a href="#" class="back link"><i class="f7-icons icon-left"></i></a></div><div class="title">Photo</div></div></div>    ';
					},
					photos : self.photoBrowserArr
				});
				
				/*window.plugins.html5Video.initialize({
					  "myvideo0" : "http://d35x2hbem77sz6.cloudfront.net/video/home-pickup.mp4"
				  }, function initializeIsFinished() {
				  window.plugins.html5Video.play("myvideo0")
				})*/
            }, 
            initVideoList: function(videoListArr = []){
                var self = this;
                
                var listEl = self.$el.find('.videosList'); 
                //var listSearchEl = self.$el.find('.searchbar');    
                var videoList = self.$app.methods.getFromStorage("videoList");
				let dateArr = self.$app.methods.sortDatePhoto(videoList);           
                
                /*if (photoListArr.length) {
                    photoListArr.sort(function(a,b){
                        if(a.AccountName < b.AccountName) return -1;
                        if(a.AccountName > b.AccountName) return 1;
                        return 0;
                    });
                }*/
				
				//self.photoBrowserArr.length = 0;
				
                self.VirtualVideoList = App.virtualList.create({
                    el: listEl, 
                    setListHeight: false,
                    // search item by item
                    searchAll: function (query, items) {
                        /*var found = [];
                        query = query.trim().toLowerCase();   
                        for (var i = 0; i < items.length; i++) {
                            if (items[i].AccountName.toLowerCase().indexOf(query) >= 0 || 
                                items[i].EMail.toLowerCase().indexOf(query) >= 0 ||                                
                                query === '') found.push(i);
                        }
                        return found; //return array with mathced indexes*/
						let found = [];
						for (let i = 0; i < items.length; i++) {
							if (items[i].title.toLowerCase().indexOf(query.toLowerCase()) >= 0 || query.trim() === '') found.push(i);
						}
						return found;
                    },
                    //List of array items
                    items: dateArr,
                    height: function(item){
                        let height = 134.94;
                        return height;
                    },
                    // Display the each item using Template7 template parameter
                    renderItem: function (item, index) {                 
                        var ret = '';
						
						ret += '<div class="list media-list">';
						ret += '  <ul>';
						ret += '	<li>';
						ret += '	  <div class="item-content">      ';  
						ret += '		<div class="item-inner">';
						ret += '		  <div class="item-title-row">';
						ret += '			<div class="item-title">' + item.title + '</div>  ';          
						ret += '		  </div>          ';
						ret += '		  <div class="item-text">';
						ret += '			<div class="row">';
						
						for (let d = 0; d < item.data.length; d ++){	
							let time = item.data[d].time.substring(8, 10) + ':' + item.data[d].time.substring(12, 14);
							
							ret += '			  <div class="col-50">';
							ret += 					'<a href="#" onclick="App.methods.openPlayer(\'http://192.168.1.1/DCIM/100video/'+item.data[d].filename+'\')" class="" data-video="'+item.data[d].filename+'">' +
													'<div class="item-content">' +
													'<div class="item-media video-item-media">' +
													'<img src="http://192.168.1.1/DCIM/103thumb/'+item.data[d].title+'">' +
													'<div class="item-media-bottom">' +
													'<div class="item-media-quality">720p</div>' +
													'<div class="item-media-time">'+time+'</div>' +
													'</div>' +
													'</div>' +
													'</div>' +
													'</a>';
							ret += '			  </div> ';					
						}
						
						ret += '			</div>';
						ret += '		  </div>';
						ret += '		</div>';
						ret += '	  </div>';
						ret += '	</li>';
						ret += '  </ul>';
						ret += '</div>';
												
						return ret;
                    }
                });				
				
				/*console.log('ar',self.photoBrowserArr);
				self.PhotoBrowserObj = self.$app.photoBrowser.create({
					theme : 'dark',
					toolbar : false,
					renderNavbar : function() {
						return '<div class="navbar"><div class="navbar-inner"><div class="left"><a href="#" class="back link"><i class="f7-icons icon-left"></i></a></div><div class="title">Photo</div></div></div>    ';
					},
					photos : self.photoBrowserArr
				});*/
            },  
        },
        on: {
            pageInit: function (e, page) {  
				var self = this;                                              
                console.log('page init');
                self.getGalleryList();		

				var page = page.$el.find('.page-content'); 

                /*page.on('click', '.pb-standalone-dark', function(e){
					self.PhotoBrowserObj.open();
				});*/
				
				page.on('taphold', '.photo-path', function(e){
				//$$('.photo-path').on('taphold', function () {
				console.log('tap');
				  App.dialog.alert('Tap hold fired!');
				});
				
				// Pull to refresh content
				var $ptrContent = $$('.ptr-content');
				// Add 'refresh' listener on it
				$ptrContent.on('ptr:refresh', function (e) {
				  // Emulate 2s loading
				  setTimeout(function () { // Prepend new list element
					
					self.getGalleryList();	
					//$ptrContent.find('ul').prepend(itemHTML);
					// When loading done, we need to reset it
					App.ptr.done(); // or e.detail();
				  }, 2000);
				});
			}
		}
    };
</script>