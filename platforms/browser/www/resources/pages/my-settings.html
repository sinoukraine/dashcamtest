<template>
	<div class="page setting-page my-settings" data-name="my-settings">
        <div class="navbar">
            <div class="navbar-inner">
                <div class="left">
                    <a class="panel-open" href="#">
                        <i class="f7-icons icon-menu"></i>
                    </a>
                </div>
				<div class="title">Settings</div>
			</div>
		</div>
		<div class="page-content">
			<div class="list-block no-hairlines setting-list">
				<ul class="left-padding right-padding no-padding-top no-padding-bottom">
					<li class="item-content no-padding">
						<a href="#" class="my-mac-address item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Dashcam Name
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<li class="item-content no-padding">
						<a href="#" class="my-wifi-settings item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Wi-Fi Settings
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<li class="item-content">
						<div class="item-inner not-empty-state border-bottom">
							<a href="#" class="my-language-settings item-inner-bottom display-flex align-items-center justify-content-space-between">
								<span>
									Language
								</span>
								<i class="f7-icons icon-right"></i>
							</a>
							<!--<p class="item-bottom-text">Device has English/Russian language options, you can switch it according to your demand</p>-->
						</div>
					</li>
					<li class="item-content">
						<div class="item-inner not-empty-state border-bottom">
							<a href="/resolution.setting/" class="item-inner-bottom display-flex align-items-center justify-content-space-between">
								<span>Resolution</span>
								<i class="f7-icons icon-right"></i>
							</a>
							<!--<p class="item-bottom-text">Two options: Full HD 1080P/Full HD 720P</p>-->
						</div>
					</li>
					<li class="item-content">
						<a href="/speed.unit.setting/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Speed Unit
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<li class="item-content">
						<div class="item-inner not-empty-state display-flex justify-content-space-between align-items-center border-bottom">
							<span class="item-caption">Sound Recording</span>
							<label class="toggle toggle-init">
								<input type="checkbox" name="SoundRecording" {{#if CheckedSoundOn}} checked {{/if}}>
								<span class="toggle-icon"></span>
							</label>
						</div>
					</li>
					
					<li class="item-content">
						<a href="/version.setting/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between ">
							<span>
								Version Check 
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<!--
					<li class="item-content no-padding">
						<a href="/voice.setting/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Voice Prompt
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<li class="item-content no-padding">
						<a href="/my-settings-service/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								After Sales Service
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>
					<li class="item-content no-padding">
						<a href="/my-settings-note/" class="item-inner not-empty-state display-flex align-items-center justify-content-space-between border-bottom">
							<span>
								Note
							</span>
							<i class="f7-icons icon-right"></i>
						</a>
					</li>-->
				</ul>
            </div>
        </div>
    </div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				IsConnect: false,
				CamName: 'Dashcam',
				WiFiRouterIp: '0.0.0.0',
				Mac: '00.00.00.00.00.00',
				CheckedSoundOn: false,
			};            

            return ret;
        },
		methods: {			
			ssidHandler: function(a){		
				//setTimeout(function () { // Prepend new list element						
                    self.$setState({
                        CamName: a,
                    });					
				//}, 2000);
			},				
			fail: function(e){	
				//App.dialog.alert(e);
			},
			navigateMacAddress: function(){
				var self = this;
				var name = self.CamName;
				var mac = self.Mac;
				mainView.router.navigate('/my-mac-address/?name='+name.toString()+'&mac='+mac.toString());
			},
			navigateIp: function(){
				var self = this;
				var ip = self.WiFiRouterIp;
				mainView.router.navigate('/my-wifi-settings/?ip='+ip.toString());
			},
			navigateLanguage: function(){
				var self = this;
				var ip = self.WiFiRouterIp;
				mainView.router.navigate('/my-language-settings/');
			},
			initConnectToCam: function(){
				var self = this;								
				
				self.$setState({
					IsConnect: true,
				});					
			},
			soundToggle: function(data) {
				var self = this;	
				let isOn = data;				
				
                self.$app.preloader.show();
				
				self.writeToCam("FFF0275D01000000100100067802F8334207");
				
				if(isOn == 'on'){
					self.writeToCam("FFF00000010000007007000101");
					console.log('sound on');
				}else{
					self.writeToCam("FFF00000010000007007000100");
					console.log('sound off');				
				}
				self.$app.methods.setInStorage({name: 'settingSoundOn', data: isOn});	
			},
			writeToCam: function(hex){
				var self = this;	
				let dataString = hex;
				let data = new Uint8Array(dataString.length/2);
				for (let i = 0, j = 0; i < data.length; i++, j+=2) {
					 data[ i ] = self.$app.methods.hexToDec(dataString[j] + dataString[j+1]);
				}
				
				self.socket.write(data);
			}
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;    				
				var myPage = $$('.my-settings');
				
				self.$app.preloader.show();
				self.socket = new Socket();	
				
				self.socket.onData = function(data) {					
					/*let convertedData = data.reduce((acc, item) => {
					  let code = item.toString(16);
					  let formattedCode = ('0' + code).slice(-2);
					  return acc + formattedCode;
					}, '');
					App.dialog.alert(convertedData);	
					*/
				  // invoked after new batch of data is received (typed array of bytes Uint8Array)
				};
				self.socket.onError = function(errorMessage) {
					self.$app.preloader.hide();
					App.dialog.alert('Can not change this state.');
				  // invoked after error occurs during connection
				};
				self.socket.onClose = function(hasError) {
					self.$app.preloader.hide();
					App.dialog.alert('State changed. Please reload Dashcam.');
				  // invoked after connection close
				};		
				self.socket.open(
				  "192.168.1.1",
				  10080,
				  function() {		
					//self.$app.preloader.hide();			
					self.initConnectToCam();	
				  },
				  function(errorMessage) {
					//self.$app.preloader.hide();
					App.dialog.alert('Cam is not initialized');					
					self.$app.methods.openCam();
					// invoked after unsuccessful opening of socket
				});
								
				var currentSoundOn = self.$app.methods.getFromStorage("settingSoundOn");
				
				if(currentSoundOn == 'on'){
					self.$setState({
                        CheckedSoundOn: true,
                    });
				}else{
					self.$setState({
                        CheckedSoundOn: false,
                    });
				}	
				
				//WifiWizard.getCurrentSSID(self.ssidHandler, self.fail);
				WifiWizard2.getConnectedSSID().then(response => {	
					//App.dialog.alert(JSON.stringify(response));	

					let mySSID = JSON.stringify(response);
					var pattern = /AUTO-VOX/i;
					var pattern1 = /M-/i;
					
					if ((pattern.test(mySSID) || pattern1.test(mySSID))) {	
						self.$setState({
							CamName: mySSID.substr(1,mySSID.length -2),
						});			
					}else{
						self.$app.dialog.alert('No Dashcam connected');		
					}					
				});	
				
				WifiWizard2.getConnectedBSSID().then(response => {	
					//App.dialog.alert(JSON.stringify(response));
					self.$setState({
                        Mac: JSON.stringify(response),
                    });						
				});	
								
				WifiWizard2.getWifiRouterIP().then(response => {						
					self.$setState({
                        WiFiRouterIp: JSON.stringify(response),
                    });						
				});	
				
				myPage.on('click', '.my-mac-address', self.navigateMacAddress);
				myPage.on('click', '.my-wifi-settings', self.navigateIp);
				myPage.on('click', '.my-language-settings', self.navigateLanguage);

				myPage.on('click', '[name="SoundRecording"]', function() {
					if(self.IsConnect){
						if($(this).is(":checked")){
							self.soundToggle('on');
						}else{
							self.soundToggle('off');
						}
					}else{
						App.dialog.alert('Please wait while cam is initializing.');
					}
				});				
			}
		}
    };
</script>
    